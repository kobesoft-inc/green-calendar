var f=Object.defineProperty;var S=(a,e,t)=>e in a?f(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var n=(a,e,t)=>(S(a,typeof e!="symbol"?e+"":e,t),t);var d=class d{constructor(e){n(this,"_root");n(this,"_visibleCount",0);n(this,"_dayTopHeight",null);n(this,"_eventHeight",null);n(this,"_localizedRemainingText","+ :count more");n(this,"_onRemainingTextClick");this._root=e,this.init()}init(){this.updateLayout(),window.addEventListener("resize",this._onResize.bind(this)),this._root.addEventListener("click",this._onClick.bind(this)),this._root.addEventListener("mousedown",this._onMouseDown.bind(this))}setLocalizedRemainingText(e){return this._localizedRemainingText=e,this}onRemainingTextClick(e){return this._onRemainingTextClick=e,this}_onResize(){this.updateLayout()}_onClick(e){this.isRemainingTextElement(e.target)&&(this._onRemainingTextClick&&this._onRemainingTextClick(this.pickDay(e.target)),e.stopImmediatePropagation())}_onMouseDown(e){this.isRemainingTextElement(e.target)&&e.stopImmediatePropagation()}updateLayout(e=!1){let t=this.getVisibleCount();(this._visibleCount!==t||e)&&(this._visibleCount=t,this._root.querySelectorAll(d.DAY_SELECTOR).forEach(i=>{this.updateDay(i,t)}))}updateDay(e,t){let i=this.getEventCount(e),r=i<t?i:t-1,s=i-r;this.setTimedEventsHeight(e,this.getEventHeight()*r),this.limitAllDayEvents(e,r-(s?1:0)),this.setRemainingCount(e,s)}getEventCount(e){return e.querySelectorAll(d.ANY_EVENT_SELECTOR).length}getEventHeight(){return this._eventHeight===null&&(this._eventHeight=this.getElementHeight(d.ANY_EVENT_SELECTOR)),this._eventHeight}setTimedEventsHeight(e,t){e.querySelector(".gc-timed-events").style.height=t+"px"}getDayHeight(){return this.getElementHeight(d.DAY_SELECTOR)}getDayTopHeight(){return this._dayTopHeight===null&&(this._dayTopHeight=this.getElementHeight(d.DAY_TOP_SELECTOR)),this._dayTopHeight}getElementHeight(e){return this._root.querySelector(e).offsetHeight}getDayBodyHeight(){return this.getDayHeight()-this.getDayTopHeight()}getVisibleCount(){return Math.floor(this.getDayBodyHeight()/this.getEventHeight())}limitAllDayEvents(e,t){e.querySelectorAll(".gc-all-day-events .gc-all-day-event-container").forEach((i,r)=>{r<=t?i.classList.remove("gc-hidden"):i.classList.add("gc-hidden")})}setRemainingCount(e,t){let i=e.querySelector(".gc-remaining-container");t>0?(i.children[0].innerText=this.makeRemainingText(t),i.classList.remove("gc-hidden")):i.classList.add("gc-hidden")}makeRemainingText(e){return this._localizedRemainingText.replace(":count",String(e))}isRemainingTextElement(e){return e.closest(".gc-remaining-container")&&this._root.contains(e)}pickDay(e){return e.closest(".gc-day")}};n(d,"DAY_SELECTOR",".gc-days .gc-day"),n(d,"DAY_TOP_SELECTOR",".gc-day-top"),n(d,"ANY_EVENT_SELECTOR",".gc-timed-events > .gc-timed-event-container, .gc-timed-events > .gc-all-day-event-container");var h=d;var u=class{constructor(e){n(this,"_root");n(this,"_containerSelector",null);n(this,"_elementSelector",null);n(this,"_propertyName",null);n(this,"_selectionStart",null);n(this,"_selectionEnd",null);n(this,"_onSelect",null);this._root=e}registerCallbacks(){this._root.addEventListener("mousedown",this._mouseDown.bind(this)),this._root.addEventListener("mousemove",this._mouseMove.bind(this)),this._root.addEventListener("mouseup",this._mouseUp.bind(this))}setContainerSelector(e){return this._containerSelector=e,this}setElementSelector(e){return this._elementSelector=e,this}setPropertyName(e){return this._propertyName=e,this}onSelect(e){return this._onSelect=e,this}select(e){return this._selectionStart=this._selectionEnd=e,this.update(),this}selectEnd(e){return this._selectionEnd=e,this.update(),this}deselect(){this.select(null)}getSelection(){return[this._selectionStart,this._selectionEnd].sort()}isSelected(){return this._selectionStart!==null&&this._selectionEnd!==null}_mouseDown(e){let t=this.pickDateTime(e.target);t&&(this.select(t),e.stopImmediatePropagation())}_mouseMove(e){let t=this.pickDateTimeByPosition(e.x,e.y);t&&(this.selectEnd(t),e.stopImmediatePropagation())}_mouseUp(e){if(this.isSelected()){if(this.pickDateTimeByPosition(e.x,e.y)){if(this._onSelect){let[i,r]=this.getSelection();this._onSelect(i,r)}this.deselect()}e.stopImmediatePropagation()}}pickDateTime(e){return this._root.contains(e)&&e.closest(this._containerSelector)?e.closest(this._elementSelector+":not(.disabled)")?.dataset[this._propertyName]:null}pickDateTimeByPosition(e,t){return Array.from(this._root.querySelectorAll(this._containerSelector+" "+this._elementSelector)).filter(i=>{let r=i.getBoundingClientRect();return r.left<=e&&e<=r.right&&r.top<=t&&t<=r.bottom}).at(0)?.dataset[this._propertyName]}getElementByDateTime(e){return this._root.querySelector(this._containerSelector+" "+this._elementSelector+"[data-"+this._propertyName+'="'+e+'"]')}update(){let[e,t]=[this._selectionStart,this._selectionEnd].sort();this._root.querySelectorAll(this._containerSelector+" "+this._elementSelector).forEach(i=>{let r=i.dataset[this._propertyName];e<=r&&r<=t?i.classList.add("gc-selected"):i.classList.remove("gc-selected")})}};var p=class{constructor(e){n(this,"_root");this._root=e}registerCallbacks(){window.addEventListener("click",()=>this.close())}open(e){this.buildPopup(e),this.layoutPopup(e)}close(){this.findPopupElement().classList.add("gc-hidden")}findPopupElement(){return this._root.querySelector(".gc-day-grid-popup")}buildPopup(e){let t=this.findPopupElement(),i=e.querySelector(".gc-day-body").cloneNode(!0),r=t.querySelector(".gc-day-body");this.replaceAllDayEvents(i,this.getAllDayEventKeys(i)),r.parentNode.replaceChild(i,r),this.adjustPopup(t),t.querySelector(".gc-date").innerText=e.querySelector(".gc-date").innerText}getAllDayEventKeys(e){return Array.from(e.querySelectorAll(".gc-timed-events .gc-all-day-event-container[data-key]")).map(t=>t.dataset.key).filter(t=>t!=="")}replaceAllDayEvents(e,t){Array.from(e.querySelectorAll(".gc-all-day-event-container")).forEach(r=>r.parentNode.removeChild(r));let i=e.querySelector(".gc-all-day-events");t.forEach(r=>{let s=this._root.querySelector('.gc-all-day-events .gc-all-day-event-container[data-key="'+r+'"]').cloneNode(!0);s.classList.add("gc-start","gc-end"),s.classList.remove("gc-hidden"),i.appendChild(s)})}adjustPopup(e){e.classList.remove("gc-hidden"),e.style.width=e.style.height="auto";let t=e.querySelector(".gc-timed-events");t.style.height="auto";let i=e.querySelector(".gc-remaining-container");i.parentNode.removeChild(i)}layoutPopup(e){let t=this.findPopupElement(),i=t.getBoundingClientRect(),r=e.getBoundingClientRect(),s=r.left-1+window.scrollX,l=r.top-1+window.scrollY,c=Math.max(r.width*1.1,i.width),g=Math.max(r.height,i.height);s+c>window.innerWidth&&(s=window.innerWidth-c),l+g>window.innerHeight&&(s=window.innerHeight-g),t.style.left=s+"px",t.style.top=l+"px",t.style.width=c+"px",t.style.height=g+"px"}};var m=class m{static toDateString(e){return new Date(e).toLocaleDateString("sv-SE")}static toDateTimeString(e){return m.toDateString(e)+" "+new Date(e).toLocaleTimeString("en-GB")}static addDays(e,t){return Date.parse(e)+t*m.MILLISECONDS_PER_DAY}static diffDays(e,t){let i=new Date(e),r=new Date(t);return i.setHours(0,0,0,0),r.setHours(0,0,0,0),Math.floor((r.getTime()-i.getTime())/m.MILLISECONDS_PER_DAY)}static diffInMilliseconds(e,t){return Date.parse(t)-Date.parse(e)}static overlapPeriod(e,t,i,r){let s=e<=i?i:e,l=t<=r?t:r;return s<=l?[s,l]:[null,null]}};n(m,"MILLISECONDS_PER_DAY",24*60*60*1e3);var o=m;var E=class{constructor(e,t){n(this,"_root");n(this,"_containerSelector",null);n(this,"_eventSelector",null);n(this,"_selector",null);n(this,"_headCursor","gc-cursor-w-resize");n(this,"_tailCursor","gc-cursor-e-resize");n(this,"_dragging",null);n(this,"_draggingPrevDate",null);n(this,"_draggingCount",0);n(this,"_grabbedDate");n(this,"_grabbedStart",!1);n(this,"_grabbedEnd",!1);n(this,"_onEvent",null);n(this,"_onMove",null);n(this,"_onPreview",null);this._root=e,this._selector=t}registerCallbacks(){this._root.addEventListener("mousedown",this._onMouseDown.bind(this)),this._root.addEventListener("mousemove",this._onMouseMove.bind(this)),this._root.addEventListener("mouseup",this._onMouseUp.bind(this))}_onMouseDown(e){let t=this.pickEvent(e.target);t&&(this._grabbedStart=this._grabbedEnd=!0,this.hitHead(e.target)&&(this._grabbedEnd=!1),this.hitTail(e.target)&&(this._grabbedStart=!1),this._grabbedDate=this._selector.pickDateTimeByPosition(e.x,e.y),this._dragging=t,this.setDragging(this._dragging.dataset.key,!0),this._draggingPrevDate=null,this.updatePreview(this._grabbedDate),this.updateCursor(),this._draggingCount=0,e.stopImmediatePropagation())}_onMouseMove(e){if(this._dragging){let t=this._selector.pickDateTimeByPosition(e.x,e.y);t&&this.updatePreview(t),this._draggingCount++,e.stopImmediatePropagation()}}_onMouseUp(e){if(this._dragging){let t=this._dragging.dataset.key,i=this._selector.pickDateTimeByPosition(e.x,e.y);if(i&&this._grabbedDate!==i){let[r,s]=this.getChangedPeriod(i);this._onMove&&this._onMove(t,r,s)}else this._draggingCount<3?this._onEvent&&this._onEvent(t):(this._onPreview&&this._onPreview(this._dragging,null,null),this.setDragging(t,!1));this._dragging=null,this._grabbedStart=this._grabbedEnd=null,this.updateCursor(),e.stopImmediatePropagation()}}setContainerSelector(e){return this._containerSelector=e,this}setEventSelector(e){return this._eventSelector=e,this}setHeadCursor(e){return this._headCursor=e,this}setTailCursor(e){return this._tailCursor=e,this}onEvent(e){return this._onEvent=e,this}onMove(e){return this._onMove=e,this}onPreview(e){return this._onPreview=e,this}isDragging(){return this._dragging!==null}getGrabbedDate(){return this._grabbedDate}pickEvent(e){return this._root.contains(e)&&e.closest(this._containerSelector)?e.closest(this._eventSelector):null}hitHead(e){return!!e.closest(".gc-head")}hitTail(e){return!!e.closest(".gc-tail")}setDragging(e,t){this._root.querySelectorAll(this._eventSelector+'[data-key="'+e+'"]').forEach(i=>{t?i.classList.add("gc-dragging"):i.classList.remove("gc-dragging")})}getChangedPeriod(e){let t=o.diffInMilliseconds(this._grabbedDate,e),i=o.toDateTimeString(Date.parse(this._dragging.dataset.start)+(this._grabbedStart?t:0)),r=o.toDateTimeString(Date.parse(this._dragging.dataset.end)+(this._grabbedEnd?t:0));return i=i.substring(0,this._grabbedDate.length),r=r.substring(0,this._grabbedDate.length),i>r&&(this._grabbedStart&&(i=r),this._grabbedEnd&&(r=i)),[i,r]}updateCursor(){this._root.classList.remove(this._headCursor,this._tailCursor),this._grabbedStart&&this._grabbedEnd?this._root.classList.add("gc-cursor-move"):this._grabbedStart?this._root.classList.add(this._headCursor):this._grabbedEnd&&this._root.classList.add(this._tailCursor)}updatePreview(e){if(this._draggingPrevDate!==e){let[t,i]=this.getChangedPeriod(e);this._onPreview&&this._onPreview(this._dragging,t,i),this._draggingPrevDate=e}}};var v=class{constructor(e,t){n(this,"_root");n(this,"_containerSelector",null);n(this,"_dateSelector",null);n(this,"_resizer",null);n(this,"_hover",null);n(this,"_onEvent",null);n(this,"_onMove",null);this._root=e,this._dateSelector=t,this.init()}init(){this._resizer=new E(this._root,this._dateSelector).setEventSelector(".gc-all-day-event-container").setHeadCursor("gc-cursor-w-resize").setTailCursor("gc-cursor-e-resize").onEvent(e=>{this._onEvent&&this._onEvent(e)}).onMove((e,t,i)=>{this._onMove&&this._onMove(e,t,i)}).onPreview((e,t,i)=>{this.removePreview(),t&&i&&this.createPreview(e,t,i)})}registerCallbacks(){this._resizer.registerCallbacks(),this._root.addEventListener("mouseover",this._onMouseOver.bind(this))}_onMouseOver(e){if(this._resizer.isDragging())return;let t=this.pickAllDayEvent(e.target,!0),i=t?t.dataset.key:null;i!==this._hover&&(this.setHoverAllDayEvent(this._hover,!1),this.setHoverAllDayEvent(this._hover=i,!0))}setContainerSelector(e){return this._resizer.setContainerSelector(e),this._containerSelector=e,this}onEvent(e){return this._onEvent=e,this}onMove(e){return this._onMove=e,this}pickAllDayEvent(e,t=!1){return this._root.contains(e)&&e.closest(this._containerSelector+(t?"":", .gc-day-grid-popup"))?e.closest(".gc-all-day-event-container"):null}setHoverAllDayEvent(e,t){e&&this._root.querySelectorAll('.gc-all-day-event-container[data-key="'+e+'"]').forEach(i=>{t?i.classList.add("gc-hover"):i.classList.remove("gc-hover")})}createPreview(e,t,i){Array.from(this._root.querySelectorAll(".gc-week, .gc-all-day-section")).forEach(r=>{let[s,l]=this.getWeekPeriod(r);if(s&&l){let[c,g]=o.overlapPeriod(t,i,s,l);if(c&&g){let y=r.querySelector('.gc-day[data-date="'+c+'"] .gc-all-day-event-preview');s<=this._resizer.getGrabbedDate()&&this._resizer.getGrabbedDate()<=l&&this.addEmptyAllDayEvents(y,this.getIndexInParent(e));let b=e.cloneNode(!0),T=o.diffDays(c,g)+1;this.adjustPreview(b,T,c===t,g===i),y.appendChild(b)}}})}getWeekPeriod(e){let t=e.querySelectorAll(".gc-day:not(.gc-disabled)");return t.length>0?[t[0].dataset.date,t[t.length-1].dataset.date]:[null,null]}adjustPreview(e,t,i,r){e.classList.remove("gc-dragging"),e.classList.remove("gc-start"),e.classList.remove("gc-end");for(let s=1;s<=7;s++)e.classList.remove("gc-"+s+"days");return e.classList.add("gc-"+t+"days"),i&&e.classList.add("gc-start"),r&&e.classList.add("gc-end"),e}getIndexInParent(e){return Array.from(e.parentNode.children).indexOf(e)}addEmptyAllDayEvents(e,t){for(let i=0;i<t;i++){let r=document.createElement("div");r.classList.add("gc-all-day-event-container"),e.appendChild(r)}}removePreview(){Array.from(this._root.querySelectorAll(".gc-all-day-event-preview")).forEach(e=>e.parentNode.replaceChild(e.cloneNode(!1),e))}};var _=class{constructor(e,t,i){n(this,"_root");n(this,"_dateSelector");n(this,"_alpine");n(this,"_dragging",null);n(this,"_onEvent");n(this,"_onMove");this._root=e,this._dateSelector=t,this._alpine=i}registerCallbacks(){this._root.addEventListener("click",this._onClick.bind(this)),this._root.addEventListener("mousedown",this._onMouseDown.bind(this)),this._root.addEventListener("dragstart",this._onDragStart.bind(this)),this._root.addEventListener("dragover",this._onDragOver.bind(this)),this._root.addEventListener("drop",this._onDrop.bind(this)),this._root.addEventListener("dragend",this._onDragEnd.bind(this))}onEvent(e){return this._onEvent=e,this}onMove(e){return this._onMove=e,this}_onClick(e){let t=this.pickEvent(e.target)?.dataset.key;t&&(this._onEvent&&this._onEvent(t),e.stopImmediatePropagation())}_onMouseDown(e){this.pickEvent(e.target)&&e.stopImmediatePropagation()}_onDragStart(e){let t=this.pickEvent(e.target);t&&(this._dragging=t,e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",t.dataset.key),this._alpine.$nextTick(()=>{this.addDraggingClass()}))}_onDragOver(e){let t=this._dateSelector.pickDateTimeByPosition(e.x,e.y);t&&(this._dateSelector.select(t),e.preventDefault())}_onDrop(e){let t=this._dateSelector.pickDateTimeByPosition(e.x,e.y),i=e.dataTransfer.getData("text/plain");if(t){let r=o.diffDays(this._dragging.dataset.start,t);if(r!==0){let s=o.toDateTimeString(o.addDays(this._dragging.dataset.start,r)),l=o.toDateTimeString(o.addDays(this._dragging.dataset.end,r));this._dragging=null,this._onMove&&this._onMove(i,s,l)}}}_onDragEnd(e){this._dateSelector.deselect(),this._dragging&&(this._dragging.classList.remove("gc-dragging"),this._dragging=null)}pickEvent(e){return this._root.contains(e)&&e.closest(".gc-day-grid, .gc-day-grid-popup")?e.closest(".gc-timed-event-container"):null}addDraggingClass(){this._dragging&&this._dragging.classList.add("gc-dragging")}};function D(a){return{dayGridLimit:h,dayGridPopup:p,dateSelector:u,timedEvent:_,allDayEvent:v,init(){this.dayGridPopup=new p(this.$el),this.dayGridLimit=new h(this.$el).setLocalizedRemainingText(a.remaining).onRemainingTextClick(e=>this.dayGridPopup.open(e)),this.dateSelector=new u(this.$el).setContainerSelector(".gc-day-grid").setElementSelector(".gc-day").setPropertyName("date").onSelect((e,t)=>{this.$wire.onDate(e+" 00:00:00",t+" 23:59:59")}),this.allDayEvent=new v(this.$el,this.dateSelector).setContainerSelector(".gc-day-grid").onMove((e,t,i)=>{this.$wire.onMove(e,t,i)}).onEvent(e=>{this.$wire.onEvent(e)}),this.timedEvent=new _(this.$el,this.dateSelector,this).onEvent(e=>{this.$wire.onEvent(e)}).onMove((e,t,i)=>{this.$wire.onMove(e,t,i)}),this.dayGridPopup.registerCallbacks(),this.allDayEvent.registerCallbacks(),this.timedEvent.registerCallbacks(),this.dateSelector.registerCallbacks(),Livewire.on("refreshCalendar",()=>{this.$nextTick(()=>this.dayGridLimit.updateLayout(!0))})}}}export{D as default};
