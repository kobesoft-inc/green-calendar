var g=class g{static toDateString(t){return new Date(t).toLocaleDateString("sv-SE")}static toDateTimeString(t){return g.toDateString(t)+" "+new Date(t).toLocaleTimeString("en-GB")}static addDays(t,e){return Date.parse(t.substring(0,10)+" 00:00:00")+e*g.MILLISECONDS_PER_DAY}static diffDays(t,e){let i=new Date(t),r=new Date(e);return i.setHours(0,0,0,0),r.setHours(0,0,0,0),Math.floor((r.getTime()-i.getTime())/g.MILLISECONDS_PER_DAY)}static diffInMilliseconds(t,e){return Date.parse(e)-Date.parse(t)}static overlapPeriod(t,e,i,r){let n=t<=i?i:t,o=e<=r?e:r;return n<=o?[n,o]:[null,null]}static timeSlot(t,e,i,r){return Math.floor((Date.parse(r>e?e:r)-Date.parse(t))/parseInt(i)/1e3)}static setTimeOfDateTime(t,e){return t.substring(0,10)+" "+e}static toMinutes(t){let[e,i]=t.split(":");return parseInt(e)*60+parseInt(i)}static toSeconds(t){let[e,i,r]=t.split(":");return(parseInt(e)*60+parseInt(i))*60+parseInt(r)}};g.MILLISECONDS_PER_DAY=24*60*60*1e3;var s=g;var m=class{constructor(t,e){this._containerSelector=null;this._eventSelector=null;this._selector=null;this._headCursor="gc-cursor-w-resize";this._tailCursor="gc-cursor-e-resize";this._dragging=null;this._draggingStart=null;this._draggingEnd=null;this._draggingValue=null;this._draggingCount=0;this._isGrabbingHead=!1;this._isGrabbingTail=!1;this._unit=1;this._onEvent=null;this._onMove=null;this._onPreview=null;this._root=t,this._selector=e}registerCallbacks(){this._root.addEventListener("mousedown",this._onMouseDown.bind(this)),this._root.addEventListener("mousemove",this._onMouseMove.bind(this)),this._root.addEventListener("mouseup",this._onMouseUp.bind(this))}_onMouseDown(t){let e=this.pickEvent(t.target);e&&(this._isGrabbingHead=this._isGrabbingTail=e.dataset.canMove==="true"&&e.dataset.canResize==="true",e.dataset.canResize==="true"&&(this.hitHead(t.target)&&(this._isGrabbingTail=!1),this.hitTail(t.target)&&(this._isGrabbingHead=!1)),this._grabbed=this._selector.pickValueByPosition(t.x,t.y),this._dragging=e,this._draggingStart=this._dragging.dataset.start,this._draggingEnd=this._dragging.dataset.end,this.setDraggingClass(this._dragging.dataset.key,!0),this._draggingValue=null,this.updatePreview(this._grabbed),this.updateCursor(),this._draggingCount=0,t.stopImmediatePropagation())}_onMouseMove(t){if(this._dragging){let e=this._selector.pickValueByPosition(t.x,t.y);e!==null&&this.updatePreview(e),this._draggingCount++,t.stopImmediatePropagation()}}_onMouseUp(t){if(this._dragging){let e=this._dragging.dataset.key,i=this._selector.pickValueByPosition(t.x,t.y);if(i!==null&&this._grabbed!==i){let[r,n]=this.drag(i);this._onMove&&r!==null&&n!==null&&this._onMove(e,r,n)}else this._draggingCount<3?this._dragging.dataset.canClick==="true"&&this._onEvent&&this._onEvent(e):(this._onPreview&&this._onPreview(this._dragging,null,null),this.setDraggingClass(e,!1));this._dragging=null,this._isGrabbingHead=this._isGrabbingTail=null,this.updateCursor(),t.stopImmediatePropagation()}}setContainerSelector(t){return this._containerSelector=t,this}setEventSelector(t){return this._eventSelector=t,this}setHeadCursor(t){return this._headCursor=t,this}setTailCursor(t){return this._tailCursor=t,this}setUnit(t){return this._unit=t,this}onEvent(t){return this._onEvent=t,this}onMove(t){return this._onMove=t,this}onPreview(t){return this._onPreview=t,this}isDragging(){return this._dragging!==null}getGrabbedDate(){return this._grabbed}pickEvent(t){return this._root.contains(t)&&t.closest(this._containerSelector)?t.closest(this._eventSelector):null}hitHead(t){return!!t.closest(".gc-head")}hitTail(t){return!!t.closest(".gc-tail")}setDraggingClass(t,e){this._root.querySelectorAll(this._eventSelector+'[data-key="'+t+'"]').forEach(i=>{e?i.classList.add("gc-dragging"):i.classList.remove("gc-dragging")})}isAllDayDragging(){return this._dragging?.dataset.allDay==="true"}isNumber(t){return/^\d+$/.test(t)}drag(t){return this.isNumber(t)?this.dragNumber(t):this.dragDateTime(t)}dragDateTime(t){let e=s.diffInMilliseconds(this._grabbed,t),i=s.toDateTimeString(Date.parse(this._draggingStart)+(this._isGrabbingHead?e:0)),r=s.toDateTimeString(Date.parse(this._draggingEnd)+(this._isGrabbingTail?e:0));return i=i.substring(0,this._grabbed.length),r=r.substring(0,this._grabbed.length),i>r&&(this._isGrabbingHead&&(i=r),this._isGrabbingTail&&(r=i)),[i,r]}dragNumber(t){let e=parseInt(t)-parseInt(this._grabbed),i=parseInt(this._draggingStart)+(this._isGrabbingHead?e:0),r=parseInt(this._draggingEnd)+(this._isGrabbingTail?e:0);return this.isAllDayDragging()&&(i=Math.floor(i/this._unit)*this._unit,r=Math.floor(r/this._unit)*this._unit),i>r&&(this._isGrabbingHead&&(i=r),this._isGrabbingTail&&(r=i)),[i,r]}updateCursor(){this._root.classList.remove(this._headCursor,this._tailCursor),this._isGrabbingHead&&this._isGrabbingTail?this._root.classList.add("gc-cursor-move"):this._isGrabbingHead?this._root.classList.add(this._headCursor):this._isGrabbingTail&&this._root.classList.add(this._tailCursor)}updatePreview(t){if(this._draggingValue!==t){let[e,i]=this.drag(t);this._onPreview&&this._onPreview(this._dragging,e,i),this._draggingValue=t}}isGrabbingHead(){return this._isGrabbingHead}isGrabbingTail(){return this._isGrabbingTail}isGrabbingBody(){return this._isGrabbingHead&&this._isGrabbingTail}};var h=class{constructor(t,e){this._containerSelector=null;this._dateSelector=null;this._resizer=null;this._hover=null;this._onEvent=null;this._onMove=null;this._root=t,this._dateSelector=e,this.init()}init(){this._resizer=new m(this._root,this._dateSelector).setEventSelector(".gc-all-day-event-container").setHeadCursor("gc-cursor-w-resize").setTailCursor("gc-cursor-e-resize").onEvent(t=>{this._onEvent&&this._onEvent(t)}).onMove((t,e,i)=>{this._onMove&&this._onMove(t,e,i)}).onPreview((t,e,i)=>{this.removePreview(),e&&i&&this.createPreview(t,e,i)})}registerCallbacks(){this._resizer.registerCallbacks(),this._root.addEventListener("mouseover",this._onMouseOver.bind(this))}_onMouseOver(t){if(this._resizer.isDragging())return;let e=this.pickAllDayEvent(t.target,!0),i=e?e.dataset.key:null;i!==this._hover&&(this.setHoverAllDayEvent(this._hover,!1),this.setHoverAllDayEvent(this._hover=i,!0))}setContainerSelector(t){return this._resizer.setContainerSelector(t),this._containerSelector=t,this}onEvent(t){return this._onEvent=t,this}onMove(t){return this._onMove=t,this}pickAllDayEvent(t,e=!1){return this._root.contains(t)&&t.closest(this._containerSelector+(e?"":", .gc-day-grid-popup"))?t.closest(".gc-all-day-event-container"):null}setHoverAllDayEvent(t,e){t&&this._root.querySelectorAll('.gc-all-day-event-container[data-key="'+t+'"]').forEach(i=>{e?i.classList.add("gc-hover"):i.classList.remove("gc-hover")})}createPreview(t,e,i){Array.from(this._root.querySelectorAll(".gc-week, .gc-all-day-section")).forEach(r=>{let[n,o]=this.getWeekPeriod(r);if(n&&o){let[c,d]=s.overlapPeriod(e,i,n,o);if(c&&d){let E=r.querySelector('.gc-day[data-date="'+c+'"] .gc-all-day-event-preview');n<=this._resizer.getGrabbedDate()&&this._resizer.getGrabbedDate()<=o&&this.addEmptyAllDayEvents(E,this.getIndexInParent(t));let b=t.cloneNode(!0),y=s.diffDays(c,d)+1;this.adjustPreview(b,y,c===e,d===i),E.appendChild(b)}}})}getWeekPeriod(t){let e=t.querySelectorAll(".gc-day:not(.gc-disabled)");return e.length>0?[e[0].dataset.date,e[e.length-1].dataset.date]:[null,null]}adjustPreview(t,e,i,r){t.classList.remove("gc-dragging"),t.classList.remove("gc-start"),t.classList.remove("gc-end");for(let n=1;n<=7;n++)t.classList.remove("gc-"+n+"days");return t.classList.add("gc-"+e+"days"),i&&t.classList.add("gc-start"),r&&t.classList.add("gc-end"),t}getIndexInParent(t){return Array.from(t.parentNode.children).indexOf(t)}addEmptyAllDayEvents(t,e){for(let i=0;i<e;i++){let r=document.createElement("div");r.classList.add("gc-all-day-event-container"),t.appendChild(r)}}removePreview(){Array.from(this._root.querySelectorAll(".gc-all-day-event-preview")).forEach(t=>t.parentNode.replaceChild(t.cloneNode(!1),t))}};var a=class a{constructor(t){this._visibleCount=0;this._dayTopHeight=null;this._eventHeight=null;this._localizedRemainingText="+ :count more";this._root=t,this.init()}init(){this.updateLayout(),window.addEventListener("resize",this._onResize.bind(this)),this._root.addEventListener("click",this._onClick.bind(this)),this._root.addEventListener("mousedown",this._onMouseDown.bind(this))}setLocalizedRemainingText(t){return this._localizedRemainingText=t,this}onRemainingTextClick(t){return this._onRemainingTextClick=t,this}_onResize(){this.updateLayout()}_onClick(t){this.isRemainingTextElement(t.target)&&(this._onRemainingTextClick&&this._onRemainingTextClick(this.pickDay(t.target)),t.stopImmediatePropagation())}_onMouseDown(t){this.isRemainingTextElement(t.target)&&t.stopImmediatePropagation()}updateLayout(t=!1){let e=this.getVisibleCount();(this._visibleCount!==e||t)&&(this._visibleCount=e,this._root.querySelectorAll(a.DAY_SELECTOR).forEach(i=>{this.updateDay(i,e)}))}updateDay(t,e){let i=this.getEventCount(t),r=i<e?i:e-1,n=i-r;this.setTimedEventsHeight(t,this.getEventHeight()*r),this.limitAllDayEvents(t,r-(n?1:0)),this.setRemainingCount(t,n)}getEventCount(t){return t.querySelectorAll(a.ANY_EVENT_SELECTOR).length}getEventHeight(){return this._eventHeight===null&&(this._eventHeight=this.getElementHeight(a.ANY_EVENT_SELECTOR)),this._eventHeight??1}setTimedEventsHeight(t,e){t.querySelector(".gc-timed-events").style.height=e+"px"}getDayHeight(){return this.getElementHeight(a.DAY_SELECTOR)}getDayTopHeight(){return this._dayTopHeight===null&&(this._dayTopHeight=this.getElementHeight(a.DAY_TOP_SELECTOR)),this._dayTopHeight}getElementHeight(t){return this._root.querySelector(t)?.offsetHeight}getDayBodyHeight(){return this.getDayHeight()-this.getDayTopHeight()}getVisibleCount(){return Math.floor(this.getDayBodyHeight()/this.getEventHeight())}limitAllDayEvents(t,e){t.querySelectorAll(".gc-all-day-events .gc-all-day-event-container").forEach((i,r)=>{r<=e?i.classList.remove("gc-hidden"):i.classList.add("gc-hidden")})}setRemainingCount(t,e){let i=t.querySelector(".gc-remaining-container");e>0?(i.children[0].innerText=this.makeRemainingText(e),i.classList.remove("gc-hidden")):i.classList.add("gc-hidden")}makeRemainingText(t){return this._localizedRemainingText.replace(":count",String(t))}isRemainingTextElement(t){return t.closest(".gc-remaining-container")&&this._root.contains(t)}pickDay(t){return t.closest(".gc-day")}};a.DAY_SELECTOR=".gc-days .gc-day",a.DAY_TOP_SELECTOR=".gc-day-top",a.ANY_EVENT_SELECTOR=".gc-timed-events > .gc-timed-event-container, .gc-timed-events > .gc-all-day-event-container";var u=a;var p=class{constructor(t){this._root=t}registerCallbacks(){window.addEventListener("click",()=>this.close())}open(t){this.buildPopup(t),this.layoutPopup(t)}close(){this.findPopupElement().classList.add("gc-hidden")}findPopupElement(){return this._root.querySelector(".gc-day-grid-popup")}buildPopup(t){let e=this.findPopupElement(),i=t.querySelector(".gc-day-body").cloneNode(!0),r=e.querySelector(".gc-day-body");this.replaceAllDayEvents(i,this.getAllDayEventKeys(i)),r.parentNode.replaceChild(i,r),this.adjustPopup(e),e.querySelector(".gc-date").innerText=t.querySelector(".gc-date").innerText}getAllDayEventKeys(t){return Array.from(t.querySelectorAll(".gc-timed-events .gc-all-day-event-container[data-key]")).map(e=>e.dataset.key).filter(e=>e!=="")}replaceAllDayEvents(t,e){Array.from(t.querySelectorAll(".gc-all-day-event-container")).forEach(r=>r.parentNode.removeChild(r));let i=t.querySelector(".gc-all-day-events");e.forEach(r=>{let n=this._root.querySelector('.gc-all-day-events .gc-all-day-event-container[data-key="'+r+'"]').cloneNode(!0);n.classList.add("gc-start","gc-end"),n.classList.remove("gc-hidden"),i.appendChild(n)})}adjustPopup(t){t.classList.remove("gc-hidden"),t.style.width=t.style.height="auto";let e=t.querySelector(".gc-timed-events");e.style.height="auto";let i=t.querySelector(".gc-remaining-container");i.parentNode.removeChild(i)}layoutPopup(t){let e=this.findPopupElement(),i=e.getBoundingClientRect(),r=t.getBoundingClientRect(),n=r.left-1+window.scrollX,o=r.top-1+window.scrollY,c=Math.max(r.width*1.1,i.width),d=Math.max(r.height,i.height);n+c>window.innerWidth&&(n=window.innerWidth-c),o+d>window.innerHeight&&(n=window.innerHeight-d),e.style.left=n+"px",e.style.top=o+"px",e.style.width=c+"px",e.style.height=d+"px"}};var _=class{constructor(t,e,i){this._dragging=null;this._root=t,this._dateSelector=e,this._alpine=i}registerCallbacks(){this._root.addEventListener("click",this._onClick.bind(this)),this._root.addEventListener("mousedown",this._onMouseDown.bind(this)),this._root.addEventListener("dragstart",this._onDragStart.bind(this)),this._root.addEventListener("dragover",this._onDragOver.bind(this)),this._root.addEventListener("drop",this._onDrop.bind(this)),this._root.addEventListener("dragend",this._onDragEnd.bind(this))}onEvent(t){return this._onEvent=t,this}onMove(t){return this._onMove=t,this}_onClick(t){let e=this.pickEvent(t.target);if(e?.dataset.canClick==="true"){let i=e?.dataset.key;i&&(this._onEvent&&this._onEvent(i),t.stopImmediatePropagation())}}_onMouseDown(t){this.pickEvent(t.target)&&t.stopImmediatePropagation()}_onDragStart(t){let e=this.pickEvent(t.target);e&&(this._dragging=e,t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("text/plain",e.dataset.key),this._alpine.$nextTick(()=>{this.addDraggingClass()}))}_onDragOver(t){let e=this._dateSelector.pickValueByPosition(t.x,t.y);e&&(this._dateSelector.select(e),t.preventDefault())}_onDrop(t){let e=this._dateSelector.pickValueByPosition(t.x,t.y),i=t.dataTransfer.getData("text/plain");if(e){let r=s.diffDays(this._dragging.dataset.start,e);if(r!==0){let n=s.toDateTimeString(s.addDays(this._dragging.dataset.start,r)),o=s.toDateTimeString(s.addDays(this._dragging.dataset.end,r));this._dragging=null,this._onMove&&this._onMove(i,n,o)}}}_onDragEnd(t){this._dateSelector.deselect(),this._dragging&&(this._dragging.classList.remove("gc-dragging"),this._dragging=null)}pickEvent(t){return this._root.contains(t)&&t.closest(".gc-day-grid, .gc-day-grid-popup")?t.closest(".gc-timed-event-container"):null}addDraggingClass(){this._dragging&&this._dragging.classList.add("gc-dragging")}};var v=class{constructor(t){this._containerSelector=null;this._elementSelector=null;this._propertyName=null;this._dateSelectionStart=null;this._dateSelectionEnd=null;this._resourceSelectionStart=null;this._resourceSelectionEnd=null;this._enabled=!0;this._multipleDates=!1;this._multipleResources=!1;this._resourceIds=null;this._onDraw=null;this._onSelect=null;this._root=t}registerCallbacks(){this._root.addEventListener("mousedown",this._mouseDown.bind(this)),this._root.addEventListener("mousemove",this._mouseMove.bind(this)),this._root.addEventListener("mouseup",this._mouseUp.bind(this))}setContainerSelector(t){return this._containerSelector=t,this}setElementSelector(t){return this._elementSelector=t,this}setPropertyName(t){return this._propertyName=t,this}setEnabled(t){return this._enabled=t,this}setMultipleDates(t){return this._multipleDates=t,this}setMultipleResources(t,e){return this._multipleResources=t,this._resourceIds=e,this}onDraw(t){return this._onDraw=t,this}onSelect(t){return this._onSelect=t,this}select(t,e=null){return this._dateSelectionStart=this._dateSelectionEnd=t,this._resourceSelectionStart=this._resourceSelectionEnd=e,this.update(),this}selectEnd(t,e=null){return this._multipleDates&&(this._dateSelectionEnd=t),this._multipleResources&&(this._resourceSelectionEnd=e),this.update(),this}deselect(){this.select(null)}getResourceSelection(){if(!this._multipleResources)return this._resourceSelectionStart?[this._resourceSelectionStart]:[];let t=this._resourceIds?.indexOf(this._resourceSelectionStart)??-1,e=this._resourceIds?.indexOf(this._resourceSelectionEnd)??-1;return t>=0&&e>=0?this._resourceIds.slice(Math.min(t,e),Math.max(t,e)+1):[]}getDateSelection(){return[this._dateSelectionStart,this._dateSelectionEnd].sort()}isSelected(){return this._dateSelectionStart!==null&&this._dateSelectionEnd!==null}_mouseDown(t){if(!this._enabled)return;let e=this.pickValueByPosition(t.x,t.y),i=this.pickResourceId(t.target);e&&(this.select(e,i),t.stopImmediatePropagation())}_mouseMove(t){if(this.isSelected()){let e=this.pickValueByPosition(t.x,t.y),i=this.pickResourceId(t.target);e&&(this.selectEnd(e,i),t.stopImmediatePropagation())}}_mouseUp(t){if(this.isSelected()){let e=this.pickValueByPosition(t.x,t.y),i=this.pickResourceId(t.target);if(e){if(this.selectEnd(e,i),this._onSelect){let[r,n]=this.getDateSelection();this._onSelect(r,n,this.getResourceSelection())}this.deselect()}t.stopImmediatePropagation()}}pickResourceId(t){return this._root.contains(t)&&t.closest(this._containerSelector)?t.closest("[data-resource-id]")?.dataset.resourceId??null:null}pickValueByPosition(t,e){return Array.from(this._root.querySelectorAll(`${this._containerSelector} ${this._elementSelector}`)).find(r=>{let n=r.getBoundingClientRect();return n.left<=t&&t<=n.right&&n.top<=e&&e<=n.bottom})?.dataset[this._propertyName]??null}getElementByValue(t){return this._root.querySelector(`${this._containerSelector} ${this._elementSelector}[data-${this._propertyName}="${t}"]`)}update(){if(this._onDraw){let[t,e]=this.getDateSelection();this._onDraw(t,e,this.getResourceSelection())}else this.highlightSelection()}highlightSelection(){let[t,e]=this.getDateSelection(),i=this.getResourceSelection(),r=i.length?i.map(n=>`${this._containerSelector} [data-resource-id="${n}"] ${this._elementSelector}`).join(","):`${this._containerSelector} ${this._elementSelector}`;this._root.querySelectorAll(`${this._containerSelector} .gc-selected`).forEach(n=>{n.classList.remove("gc-selected")}),this._root.querySelectorAll(r).forEach(n=>{let o=n.dataset[this._propertyName];t<=o&&o<=e&&n.classList.add("gc-selected")})}};function S(l){return{dayGridLimit:u,dayGridPopup:p,dateSelector:v,timedEvent:_,allDayEvent:h,init(){this.dayGridPopup=new p(this.$el),this.dayGridLimit=new u(this.$el).setLocalizedRemainingText(l.remaining).onRemainingTextClick(t=>this.dayGridPopup.open(t)),this.dateSelector=new v(this.$el).setContainerSelector(".gc-day-grid").setElementSelector(".gc-day").setPropertyName("date").setEnabled(l.canSelectDates).setMultipleDates(l.canSelectMultipleDates).onSelect((t,e,i)=>{this.$wire.onDate(t+" 00:00:00",e+" 23:59:59",i)}),this.allDayEvent=new h(this.$el,this.dateSelector).setContainerSelector(".gc-day-grid").onMove((t,e,i)=>{this.$wire.onMove(t,e,i)}).onEvent(t=>{this.$wire.onEvent(t)}),this.timedEvent=new _(this.$el,this.dateSelector,this).onEvent(t=>{this.$wire.onEvent(t)}).onMove((t,e,i)=>{this.$wire.onMove(t,e,i)}),this.dayGridPopup.registerCallbacks(),this.allDayEvent.registerCallbacks(),this.timedEvent.registerCallbacks(),this.dateSelector.registerCallbacks(),Livewire.on("refreshCalendar",()=>{this.$nextTick(()=>this.dayGridLimit.updateLayout(!0))})}}}export{S as default};
